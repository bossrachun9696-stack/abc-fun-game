<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üê∞ ABC Fun English</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ABC Fun">
<link rel="apple-touch-icon" href="https://img.icons8.com/color/180/abc.png">

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #FF9F1C;
    --secondary: #2EC4B6;
    --bg: #CBF3F0;
    --card: #FFFFFF;
    --wrong: #FF5A5F;
    --correct: #2EC4B6;
  }

  body {
    font-family: 'Kanit', sans-serif;
    background-color: var(--bg);
    margin: 0; padding: 10px;
    display: flex; justify-content: center;
    min-height: 100vh; color: #333;
    overflow-x: hidden; -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  .container { width: 100%; max-width: 600px; text-align: center; padding-bottom: 50px; }

  /* Header Stats */
  .header-bar {
    background: var(--card); padding: 10px 15px; border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px;
    display: flex; justify-content: space-between; align-items: center; font-weight: bold;
  }
  .stat-pill { background: #f0f2f5; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; }

  /* Pages */
  .page { display: none; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }

  /* Cards */
  .card {
    background: var(--card); padding: 25px 20px; border-radius: 25px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 15px; position: relative;
  }

  h1 { color: var(--primary); margin: 0 0 10px 0; text-shadow: 2px 2px 0px #ffe5b4; font-size: 2.2rem; }
  
  /* Timer & Score */
  .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  
  .timer-box {
    font-size: 1.8rem; font-weight: 800; color: #555;
    background: #fff; padding: 5px 15px; border-radius: 15px;
    border: 3px solid #ddd;
  }
  
  .score-box {
    font-size: 2rem; font-weight: 800; color: #fff;
    background: var(--primary); padding: 5px 20px; border-radius: 15px;
    box-shadow: 0 4px 0 #e08e19;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  /* Buttons */
  button {
    border: none; outline: none; cursor: pointer; font-family: 'Kanit', sans-serif;
    border-radius: 50px; width: 100%; margin: 6px 0; font-weight: 600;
    transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
  }
  button:active { transform: scale(0.96); }
  
  .btn-main { background: var(--primary); color: white; font-size: 1.5rem; padding: 18px; box-shadow: 0 5px 0 #e08e19; }
  .btn-practice { background: var(--secondary); color: white; font-size: 1.2rem; padding: 12px; box-shadow: 0 5px 0 #259f93; }
  .btn-info { background: #3498db; color: white; font-size: 1rem; padding: 10px; margin-top: 10px; }
  .btn-parent { background: #95a5a6; color: white; width: auto; font-size: 0.9rem; padding: 8px 20px; margin-top: 15px; }
  .btn-back { background: #f1f2f6; color: #7f8c8d; width: auto; display: inline-block; padding: 8px 20px; }
  
  .btn-sound {
    background: #FFBF69; color: #fff; width: 80px; height: 80px;
    border-radius: 50%; font-size: 2.2rem; display: flex; align-items: center; 
    justify-content: center; margin: 0 auto; box-shadow: 0 4px 0 #e0a85c;
  }

  /* Game Elements */
  .vocab-display { font-size: 3.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; line-height: 1.1; text-shadow: 2px 2px 0 #f0f0f0;}
  .practice-vocab { font-size: 4rem; font-weight: 800; color: var(--secondary); margin: 15px 0; }
  
  .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
  .choice-btn {
    background: white; border: 3px solid var(--secondary); color: var(--secondary);
    border-radius: 20px; padding: 10px; font-size: 1.3rem; min-height: 90px;
    display: flex; align-items: center; justify-content: center;
  }

  /* History Table */
  .history-list { list-style: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
  .history-list li { 
    display: flex; flex-direction: column; padding: 15px; 
    border-bottom: 1px dashed #ccc; font-size: 0.95rem; background: #fdfdfd; margin-bottom: 5px; border-radius: 10px;
  }
  .history-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px;}
  .date-label { color: #555; font-weight: bold; }
  .badge-group { display: flex; gap: 5px; }
  .count-label { background: var(--secondary); color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem;}
  .wrong-text { color: #d63031; font-size: 0.85rem; background: #fff0f0; padding: 5px; border-radius: 5px; margin-top: 5px;}

  /* Vocab Table */
  .vocab-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
  .vocab-table th { background: var(--primary); color: white; padding: 8px; border: 1px solid #eee; }
  .vocab-table td { border: 1px solid #eee; padding: 8px; vertical-align: middle; cursor: pointer; }
  .vocab-table tr:nth-child(even) { background: #f9f9f9; }
  .hidden-text { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.3); background: #eee; border-radius: 5px; user-select: none; }
  
  .controls-bar { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; font-size: 0.9rem; }
  .checkbox-wrapper { display: flex; align-items: center; gap: 5px; }

  @keyframes popIn { from { transform: scale(0.5); opacity:0; } to { transform: scale(1); opacity:1; } }
  .correct-anim { background: var(--correct) !important; color: white !important; border-color: var(--correct) !important; transform: scale(1.05); }
  .wrong-anim { background: var(--wrong) !important; color: white !important; border-color: var(--wrong) !important; animation: shake 0.4s; }
  @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

  #mistakeList { text-align: left; max-height: 200px; overflow-y: auto; padding: 0; list-style: none; }
  #mistakeList li { background: #fff; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; }
</style>
</head>
<body>

<div class="container">
  
  <div class="header-bar">
    <div class="stat-pill">‚≠ê ‡∏£‡∏ß‡∏°: <span id="uiStars">...</span></div>
    <div class="stat-pill">üèÜ ‡πÄ‡∏•‡πà‡∏ô: <span id="uiRounds">...</span> ‡∏£‡∏≠‡∏ö</div>
    <div id="onlineIndicator" style="font-size:0.7rem; color:#ccc;">‚ö™ Check...</div>
  </div>

  <div id="homePage" class="page active">
    <div class="card">
      <h1>üê∞ ABC Fun</h1>
      <p style="color:#777; margin-bottom: 20px;">‡πÄ‡∏Å‡πà‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏â‡∏ö‡∏±‡∏ö‡∏´‡∏ô‡∏π‡∏ô‡πâ‡∏≠‡∏¢</p>
      
      <div style="background:#f9f9f9; padding:10px; border-radius:15px; margin-bottom:15px; display:flex; justify-content:center; align-items:center; gap:10px;">
        <span>üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:</span>
        <button id="soundToggle" onclick="toggleSound()" style="width:auto; padding:5px 20px; font-size:1rem; margin:0;">‡πÄ‡∏õ‡∏¥‡∏î</button>
      </div>

      <div id="loadingStatus" style="color: orange; font-style: italic; margin-bottom: 15px; font-size: 0.9rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      
      <button class="btn-main" onclick="startGame()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)</button>
      <button class="btn-practice" onclick="startPractice()">üìñ ‡∏ù‡∏∂‡∏Å‡∏ó‡πà‡∏≠‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå</button>
      
      <button class="btn-parent" onclick="showPage('parentLogin')">üîí ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</button>
    </div>
  </div>

  <div id="gamePage" class="page">
    <div class="game-header">
      <div class="timer-box">‚è≥ <span id="timerDisplay">02:00</span></div>
      <div class="score-box">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="liveScore">0</span></div>
    </div>

    <div class="card">
      <div class="vocab-display" id="gameVocab">...</div>
      <button class="btn-sound" onclick="repeatSound()">üîä</button>
      <div id="choicesBox" class="choices-grid"></div>
    </div>
    <p style="color:#888; font-size: 0.8rem;">‡∏™‡∏π‡πâ‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á! ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ô‡πâ‡∏≤</p>
  </div>

  <div id="resultPage" class="page">
    <div class="card">
      <h1 style="color:var(--primary)">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ‚è∞</h1>
      <div style="font-size: 1.5rem; margin: 20px 0; background:#f0f8ff; padding:20px; border-radius:20px;">
        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ<br>
        <span id="finalScore" style="font-size: 4rem; color:var(--primary); font-weight:800;">0</span>
      </div>
      <div style="display:flex; justify-content:space-around; font-size:1.2rem;">
        <span style="color:green">‚úî ‡∏ñ‡∏π‡∏Å: <span id="resultCorrect">0</span></span>
        <span style="color:red">‚ùå ‡∏ú‡∏¥‡∏î: <span id="resultWrong">0</span></span>
      </div>
      <button class="btn-main" onclick="showPage('homePage')" style="margin-top:20px;">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    </div>
  </div>

  <div id="practicePage" class="page">
    <div class="card">
      <div class="practice-vocab" id="pVocab">...</div>
      <div id="pReading" style="color:#666; font-size: 1.8rem; margin-bottom: 10px;">...</div>
      <div id="pMeaning" style="color:var(--primary); font-size: 2.5rem; font-weight:bold; margin:10px 0; background: #fff8e1; padding: 10px; border-radius: 15px;">...</div>
      
      <button class="btn-sound" onclick="speakCurrentPractice()" style="margin: 20px auto;">üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
        <button class="btn-back" style="font-size:1.2rem; padding:15px;" onclick="prevPractice()">‚¨ÖÔ∏è ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á</button>
        <button class="btn-back" style="font-size:1.2rem; padding:15px;" onclick="nextPractice()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
      </div>
      
      <button class="btn-info" onclick="openVocabList()">üìú ‡∏î‡∏π‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</button>
    </div>
    <button class="btn-back" onclick="showPage('homePage')">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="vocabListPage" class="page">
    <div class="card" style="padding: 15px;">
      <h2>üìú ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      
      <div class="controls-bar">
        <label class="checkbox-wrapper">
            <input type="checkbox" id="showRead" checked onchange="toggleVocabColumn('read')"> ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô
        </label>
        <label class="checkbox-wrapper">
            <input type="checkbox" id="showMean" checked onchange="toggleVocabColumn('mean')"> ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•
        </label>
      </div>
      <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">üí° ‡∏à‡∏¥‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>

      <div style="overflow-x:auto;">
        <table class="vocab-table">
            <thead>
                <tr>
                    <th style="width:10%">#</th>
                    <th style="width:30%">Vocab</th>
                    <th style="width:30%">‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô</th>
                    <th style="width:30%">‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•</th>
                </tr>
            </thead>
            <tbody id="vocabTableBody">
                </tbody>
        </table>
      </div>
      <br>
      <button class="btn-back" onclick="showPage('practicePage')">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

  <div id="parentLogin" class="page">
    <div class="card">
      <h2>üîí ‡πÇ‡∏ã‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</h2>
      <input type="password" id="pinInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="padding:15px; font-size:1.2rem; text-align:center; width:80%; border:2px solid #ddd; border-radius:15px;">
      <br><br>
      <button class="btn-main" style="width: auto; padding: 10px 40px;" onclick="checkPin()">‡∏ï‡∏Å‡∏•‡∏á</button>
      <br>
      <button class="btn-back" onclick="showPage('homePage')">‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

  <div id="parentDashboard" class="page">
    <div class="card">
      <h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏• (Cloud)</h2>
      <div style="display:flex; justify-content:space-around; background:#f0f8ff; padding:15px; border-radius:15px; margin-bottom:15px;">
        <div style="text-align:center;">
            <div style="font-size:0.8rem; color:#666;">‚≠ê ‡∏î‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div id="cloudStars" style="font-size:2rem; font-weight:bold; color:var(--primary);">...</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:0.8rem; color:#666;">üèÜ ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ (‡∏£‡∏≠‡∏ö)</div>
            <div id="cloudRounds" style="font-size:2rem; font-weight:bold; color:var(--secondary);">...</div>
        </div>
      </div>
      
      <div style="text-align:left; margin-top:10px;">üìÖ <b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</b></div>
      <ul id="historyList" class="history-list">
        <li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>
      </ul>

      <div style="text-align:left; margin-top:20px;">üìå <b>‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢ (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ):</b></div>
      <ul id="mistakeList"></ul>

      <button class="btn-back" onclick="resetCloudData()" style="color:red; font-size: 0.9rem; margin-top:20px; border: 1px solid red; background:#fff0f0;">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset Cloud)</button>
      <br>
      <button class="btn-back" onclick="showPage('homePage')">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

</div>

<script>
/**********************************************
 * CONFIG & SETUP
 **********************************************/
// *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Web App URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
const API_URL = "https://script.google.com/macros/s/AKfycbzfNeVpEL2R3sQsljaYsOjRqoFkjf2j6oM1KKXKvOi2Y0peu07j20A0ff4GZafUFg23/exec"; 
const PARENT_PIN = "0932815229";
const GAME_TIME = 120; // 2 ‡∏ô‡∏≤‡∏ó‡∏µ

// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î)
const backupWords = [
  {Vocabulary:"Apple", "‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢":"‡πÅ‡∏≠‡∏õ-‡πÄ‡∏õ‡∏¥‡∏•", "‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•":"‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•"},
  {Vocabulary:"Banana", "‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢":"‡∏ö‡∏∞-‡πÅ‡∏ô-‡∏ô‡∏∞", "‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•":"‡∏Å‡∏•‡πâ‡∏ß‡∏¢"}
];

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
let words = [];
let wordStats = JSON.parse(localStorage.getItem("wordStats")) || {};
let globalStars = 0;
let globalRounds = 0;
let isSoundEnabled = true;

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡∏°
let currentWord = null;
let gameTimerId = null;
let timeLeft = 0;
let currentScore = 0;
let sessionCorrect = 0;
let sessionWrong = 0;
let practiceIndex = 0;

/**********************************************
 * STARTUP & UTILS
 **********************************************/
window.onload = function() {
  toggleSoundUI();
  fetchData(); 
  window.speechSynthesis.getVoices();
};

function fetchData() {
    document.getElementById("loadingStatus").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud...";
    
    // *** ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cache ***
    const nocache = "&t=" + new Date().getTime();

    // ‡∏î‡∏∂‡∏á Report
    fetch(API_URL + "?action=getReport" + nocache)
    .then(res => res.json())
    .then(data => {
        if(data.summary) {
            globalStars = data.summary.stars;
            globalRounds = data.summary.rounds;
            updateUI();
        }
    })
    .catch(console.error);

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
    fetch(API_URL)
    .then(res => res.json())
    .then(data => {
        if(data.words) words = data.words;
        else if(Array.isArray(data)) words = data;
        
        if(words.length > 0) {
            document.getElementById("loadingStatus").textContent = `‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô (${words.length} ‡∏Ñ‡∏≥)`;
            document.getElementById("onlineIndicator").textContent = "üü¢ Online (Synced)";
            document.getElementById("onlineIndicator").style.color = "green";
        }
    })
    .catch(e => {
        words = backupWords;
        document.getElementById("loadingStatus").textContent = "‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)";
        document.getElementById("onlineIndicator").textContent = "üî¥ Offline";
    });
}

function toggleSound() {
  isSoundEnabled = !isSoundEnabled;
  toggleSoundUI();
  if(isSoundEnabled) {
    const u = new SpeechSynthesisUtterance("");
    window.speechSynthesis.speak(u);
  }
}

function toggleSoundUI() {
  const btn = document.getElementById("soundToggle");
  if(isSoundEnabled) {
    btn.textContent = "‡πÄ‡∏õ‡∏¥‡∏î";
    btn.style.background = "var(--correct)";
    btn.style.color = "white";
  } else {
    btn.textContent = "‡∏õ‡∏¥‡∏î";
    btn.style.background = "#ccc";
    btn.style.color = "#666";
  }
}

function speak(text, lang = "en-US") {
  if(!isSoundEnabled) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  u.rate = 0.8;
  
  const voices = window.speechSynthesis.getVoices();
  if(lang === "en-US") {
     const femaleVoice = voices.find(v => v.name.includes("Female") || v.name.includes("Google US English"));
     if(femaleVoice) u.voice = femaleVoice;
  } else if (lang === "th-TH") {
     const thaiVoice = voices.find(v => v.lang === "th-TH" || v.name.includes("Thai"));
     if(thaiVoice) u.voice = thaiVoice;
  }

  window.speechSynthesis.speak(u);
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function updateUI() {
  document.getElementById("uiStars").textContent = globalStars;
  document.getElementById("uiRounds").textContent = globalRounds;
  document.getElementById("cloudStars").textContent = globalStars;
  document.getElementById("cloudRounds").textContent = globalRounds;
}

/**********************************************
 * GAME LOGIC
 **********************************************/
function startGame() {
  if(words.length < 4) { alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
  
  currentScore = 0;
  sessionCorrect = 0;
  sessionWrong = 0;
  timeLeft = GAME_TIME;
  
  document.getElementById("liveScore").textContent = "0";
  showPage('gamePage');
  updateTimerDisplay();
  
  clearInterval(gameTimerId);
  gameTimerId = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft <= 0) finishGame();
  }, 1000);

  nextQuestion();
}

function updateTimerDisplay() {
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;
  document.getElementById("timerDisplay").textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function getWeightedWord() {
  let pool = [];
  words.forEach(w => {
    pool.push(w);
    const stat = wordStats[w.Vocabulary];
    if (stat && stat.wrong > stat.correct) { 
      pool.push(w); pool.push(w); 
    }
  });
  return pool[Math.floor(Math.random() * pool.length)];
}

function nextQuestion() {
  if(timeLeft <= 0) return;
  
  currentWord = getWeightedWord();
  document.getElementById("gameVocab").textContent = currentWord.Vocabulary;
  speak(currentWord.Vocabulary);

  let choices = [currentWord];
  while(choices.length < 4) {
    let w = words[Math.floor(Math.random() * words.length)];
    if(!choices.find(c => c.Vocabulary === w.Vocabulary)) choices.push(w);
  }
  
  const box = document.getElementById("choicesBox");
  box.innerHTML = "";
  choices.sort(() => Math.random() - 0.5).forEach(w => {
    const btn = document.createElement("button");
    btn.className = "choice-btn";
    btn.textContent = w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"];
    btn.onclick = () => checkAnswer(w, btn);
    box.appendChild(btn);
  });
}

function checkAnswer(selected, btn) {
  const allBtns = document.querySelectorAll('.choice-btn');
  allBtns.forEach(b => b.disabled = true);
  
  if(!wordStats[currentWord.Vocabulary]) {
    wordStats[currentWord.Vocabulary] = { correct:0, wrong:0, meaning: currentWord["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"] };
  }

  if(selected.Vocabulary === currentWord.Vocabulary) {
    btn.classList.add("correct-anim");
    currentScore++;
    sessionCorrect++;
    wordStats[currentWord.Vocabulary].correct++;
    if(isSoundEnabled) new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg").play().catch(e=>{});
    setTimeout(nextQuestion, 800);
  } else {
    btn.classList.add("wrong-anim");
    currentScore--;
    sessionWrong++;
    wordStats[currentWord.Vocabulary].wrong++;
    allBtns.forEach(b => {
       if(b.textContent === currentWord["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"]) b.classList.add("correct-anim");
    });
    if(isSoundEnabled) new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play().catch(e=>{});
    setTimeout(nextQuestion, 1500);
  }

  document.getElementById("liveScore").textContent = currentScore;
  localStorage.setItem("wordStats", JSON.stringify(wordStats));
}

function sendDataToSheets(stars, wrongWords) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: 'save',
      totalStars: stars,
      wrongWords: wrongWords
    })
  }).then(res => {
      console.log("Saved.");
      // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Server ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô
      setTimeout(fetchData, 1000); 
  }).catch(err => console.error("Error sending", err));
}

function finishGame() {
  clearInterval(gameTimerId);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Optimistic UI)
  globalRounds++;
  globalStars += Math.max(0, currentScore);
  updateUI();

  const wrongWordsSummary = Object.entries(wordStats)
    .filter(([_, s]) => s.wrong > 0)
    .sort((a,b) => b[1].wrong - a[1].wrong)
    .slice(0, 5)
    .map(([vocab, s]) => `${vocab}(${s.wrong})`)
    .join(", ");

  sendDataToSheets(currentScore, wrongWordsSummary);

  document.getElementById("finalScore").textContent = currentScore;
  document.getElementById("resultCorrect").textContent = sessionCorrect;
  document.getElementById("resultWrong").textContent = sessionWrong;
  showPage('resultPage');
}

function repeatSound() { if(currentWord) speak(currentWord.Vocabulary); }

/**********************************************
 * PRACTICE MODE
 **********************************************/
function startPractice() {
  if(words.length === 0) return;
  practiceIndex = 0;
  showPage('practicePage');
  renderPractice();
}

function renderPractice() {
  const w = words[practiceIndex];
  document.getElementById("pVocab").textContent = w.Vocabulary || "";
  document.getElementById("pReading").textContent = w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"] ? "‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô: " + w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"] : "";
  document.getElementById("pMeaning").textContent = w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"] ? "‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤: " + w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"] : "";
  speak(w.Vocabulary);
}

function nextPractice() { practiceIndex = (practiceIndex + 1) % words.length; renderPractice(); }
function prevPractice() { practiceIndex = practiceIndex <= 0 ? words.length - 1 : practiceIndex - 1; renderPractice(); }
function speakCurrentPractice() { speak(words[practiceIndex].Vocabulary); }

function openVocabList() {
    showPage('vocabListPage');
    const tbody = document.getElementById("vocabTableBody");
    tbody.innerHTML = "";

    words.forEach((w, index) => {
        const tr = document.createElement("tr");
        
        const tdIdx = document.createElement("td");
        tdIdx.textContent = index + 1;
        
        const tdVocab = document.createElement("td");
        tdVocab.innerHTML = `<b>${w.Vocabulary}</b>`;
        tdVocab.onclick = () => speak(w.Vocabulary, 'en-US');

        const tdRead = document.createElement("td");
        tdRead.className = "col-read";
        tdRead.textContent = w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"];
        tdRead.onclick = () => speak(w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"], 'th-TH');

        const tdMean = document.createElement("td");
        tdMean.className = "col-mean";
        tdMean.textContent = w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"];
        tdMean.onclick = () => speak(w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"], 'th-TH');

        tr.appendChild(tdIdx);
        tr.appendChild(tdVocab);
        tr.appendChild(tdRead);
        tr.appendChild(tdMean);
        tbody.appendChild(tr);
    });

    toggleVocabColumn('read');
    toggleVocabColumn('mean');
}

function toggleVocabColumn(type) {
    const isChecked = document.getElementById(type === 'read' ? 'showRead' : 'showMean').checked;
    const cells = document.querySelectorAll(type === 'read' ? '.col-read' : '.col-mean');
    cells.forEach(cell => {
        if(isChecked) cell.classList.remove('hidden-text');
        else cell.classList.add('hidden-text');
    });
}

/**********************************************
 * PARENT MODE
 **********************************************/
function checkPin() {
  if(document.getElementById("pinInput").value === PARENT_PIN) {
    document.getElementById("pinInput").value = "";
    showPage('parentDashboard');
    renderHistory(); 
    renderMistakes(); 
  } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
}

async function renderHistory() {
  const list = document.getElementById("historyList");
  list.innerHTML = "<li>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud...</li>";
  
  const nocache = "&t=" + new Date().getTime();

  try {
    const response = await fetch(API_URL + "?action=getReport" + nocache);
    const data = await response.json();
    
    if(data.summary) {
        globalStars = data.summary.stars;
        globalRounds = data.summary.rounds;
        updateUI();
    }
    
    list.innerHTML = "";
    if (!data.history || data.history.length === 0) {
      list.innerHTML = "<li style='justify-content:center; color:#888;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô Cloud</li>";
      return;
    }

    data.history.forEach(item => {
      const dateObj = new Date(item.timestamp);
      const dateStr = dateObj.toLocaleDateString("th-TH") + " " + dateObj.toLocaleTimeString("th-TH", {hour:'2-digit', minute:'2-digit'});
      
      const li = document.createElement("li");
      li.innerHTML = `
        <div class="history-header">
            <span class="date-label">${dateStr}</span>
            <div class="badge-group">
                <span class="count-label" style="background:var(--primary)">‚≠ê ${item.stars}</span>
            </div>
        </div>
        ${item.wrong ? `<div class="wrong-text">‚ùå ‡∏ú‡∏¥‡∏î: ${item.wrong}</div>` : ''}
      `;
      list.appendChild(li);
    });
  } catch (e) {
    console.error(e);
    list.innerHTML = "<li style='color:red;'>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</li>";
  }
}

function renderMistakes() {
  const list = document.getElementById("mistakeList");
  list.innerHTML = "";
  const sorted = Object.entries(wordStats).sort((a,b) => b[1].wrong - a[1].wrong).slice(0, 15);
  
  if(sorted.length === 0) { list.innerHTML = "<li style='justify-content:center; color:#888;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</li>"; return; }
  
  sorted.forEach(([vocab, s]) => {
    if(s.wrong > 0) {
      const li = document.createElement("li");
      li.innerHTML = `<span><b>${vocab}</b> (${s.meaning})</span> <span style="color:red">‡∏ú‡∏¥‡∏î ${s.wrong}</span>`;
      list.appendChild(li);
    }
  });
}

function resetCloudData() {
  if(!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô Google Sheets ‡πÅ‡∏•‡∏∞‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ\n\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "reset" })
  }).then(res => {
      alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      localStorage.clear();
      globalStars = 0;
      globalRounds = 0;
      location.reload();
  }).catch(err => {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud");
  });
}

function resetLocalData() {
    resetCloudData(); 
}
</script>

</body>
</html>
