<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üåü Family Games Hub (Diamond Edition)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2196f3">

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
  :root {
    --primary: #FF9F1C;
    --secondary: #2EC4B6;
    --bg: #eef5ff;
    --card: #FFFFFF;
    --wrong: #FF5A5F;
    --correct: #2EC4B6;
    --marked-bg: #ffebee;
    --marked-border: #ffcdd2;
  }

  body {
    font-family: 'Kanit', sans-serif;
    background-color: var(--bg);
    margin: 0; padding: 10px;
    display: flex; justify-content: center;
    min-height: 100vh; color: #333;
    overflow-x: hidden; -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  .container { width: 100%; max-width: 600px; text-align: center; padding-bottom: 50px; }

  /* Pages */
  .page { display: none; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Cards & General UI */
  .card, .math-box {
    background: var(--card); padding: 25px 20px; border-radius: 25px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 15px; position: relative;
  }
  h1 { color: var(--primary); margin: 0 0 10px 0; text-shadow: 2px 2px 0px #ffe5b4; font-size: 2.2rem; }
  
  /* Buttons */
  button {
    border: none; outline: none; cursor: pointer; font-family: 'Kanit', sans-serif;
    border-radius: 50px; width: 100%; margin: 6px 0; font-weight: 600;
    transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
  }
  button:active { transform: scale(0.96); }
  
  /* ABC App Specific Styles */
  .header-bar { background: var(--card); padding: 10px 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  .stat-pill { background: #f0f2f5; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; }
  .input-range-group { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px 0; }
  .input-box { width: 60px; padding: 8px; text-align: center; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; font-weight: bold; color: var(--primary); }
  .search-box { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 15px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }

  /* Buttons Theme */
  .btn-main { background: var(--primary); color: white; font-size: 1.5rem; padding: 18px; box-shadow: 0 5px 0 #e08e19; }
  .btn-practice { background: var(--secondary); color: white; font-size: 1.2rem; padding: 12px; box-shadow: 0 5px 0 #259f93; }
  .btn-info { background: #3498db; color: white; font-size: 1rem; padding: 10px; margin-top: 10px; }
  .btn-filter { background: #9b59b6; color: white; width:auto; padding: 5px 15px; font-size: 0.9rem; border-radius: 15px; position:absolute; top: 20px; right: 20px; box-shadow: 0 3px 0 #8e44ad; }
  .btn-parent { background: #95a5a6; color: white; width: auto; font-size: 0.9rem; padding: 8px 20px; margin-top: 15px; }
  .btn-back { background: #f1f2f6; color: #7f8c8d; width: auto; display: inline-block; padding: 8px 20px; }
  .btn-apply { background: var(--secondary); color: white; font-size: 1.1rem; padding: 10px; margin-top: 10px; }
  .btn-sound { background: #FFBF69; color: #fff; width: 80px; height: 80px; border-radius: 50%; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 4px 0 #e0a85c; }

  /* Math Specific Styles */
  #mathPage .math-box { font-family: 'Sarabun', sans-serif; }
  #mathPage button { font-family: 'Sarabun', sans-serif; font-size: 18px; padding: 12px 20px; border-radius: 18px; margin: 5px; }
  #mathPage button.back { background: #ff9800; width: 90%; color: white; }
  #mathPage .btn-lv { background: #d1d9e6; color: #444; border: 2px solid #b0b8c4; width: 80px; font-weight: bold; }
  #mathPage .btn-lv.sel { background: #0d47a1 !important; color: #fff !important; border: 3px solid #002171 !important; transform: scale(1.1); }
  #mathPage button.num { font-size: 30px; width: 70px; height: 70px; border-radius: 50%; background: #f0f0f0; color: #333; }
  #mathPage input#ans { font-size: 35px; width: 80%; padding: 10px; border-radius: 15px; border: 3px solid #2196f3; text-align: center; margin-bottom: 10px; background: #fff; }
  #mathPage .timer { font-size: 26px; color: red; font-weight: bold; margin-bottom: 10px; }
  .mathScoreBox { position: fixed; top: 10px; right: 10px; background: #ff9800; color: #fff; padding: 8px 15px; border-radius: 15px; z-index: 999; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
  
  /* Parent & Hub Styles */
  .history-card { text-align: left; background: #f1f8e9; padding: 12px; margin: 8px 0; border-radius: 12px; border-left: 6px solid #4caf50; font-size: 14px; }
  .btn-reset { background: #d32f2f; font-size: 14px; margin-top: 10px; width: 100%; color: white; padding: 10px; border-radius: 15px;}
  .score-mgmt-box { background: #fff; border: 2px solid #ddd; border-radius: 15px; padding: 15px; margin-bottom: 15px; text-align: left; }

  /* Game Elements */
  .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .timer-box { font-size: 1.8rem; font-weight: 800; color: #555; background: #fff; padding: 5px 15px; border-radius: 15px; border: 3px solid #ddd; }
  .score-box { font-size: 2rem; font-weight: 800; color: #fff; background: var(--primary); padding: 5px 20px; border-radius: 15px; box-shadow: 0 4px 0 #e08e19; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .vocab-display { font-size: 3.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; line-height: 1.1; text-shadow: 2px 2px 0 #f0f0f0;}
  .practice-vocab { font-size: 4rem; font-weight: 800; color: var(--secondary); margin: 15px 0; }
  .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
  .choice-btn { background: white; border: 3px solid var(--secondary); color: var(--secondary); border-radius: 20px; padding: 10px; font-size: 1.3rem; min-height: 90px; display: flex; align-items: center; justify-content: center; }

  /* Table & List Settings (ABC) */
  .history-list { list-style: none; padding: 0; text-align: left; overflow-y: auto; }
  .history-list li { display: flex; flex-direction: column; padding: 15px; border-bottom: 1px dashed #ccc; font-size: 0.95rem; background: #fdfdfd; margin-bottom: 5px; border-radius: 10px; }
  .history-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px;}
  .date-label { color: #555; font-weight: bold; }
  .badge-group { display: flex; gap: 5px; }
  .count-label { background: var(--secondary); color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem;}
  .wrong-text { color: #d63031; font-size: 0.85rem; background: #fff0f0; padding: 5px; border-radius: 5px; margin-top: 5px;}
  
  #vocabListPage .card { display: flex; flex-direction: column; height: 85vh; padding: 15px; background: #f4f4f4; }
  .table-wrapper { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; border-radius: 10px; background: #fff; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
  .vocab-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 1.1rem; }
  .vocab-table th { background: var(--primary); color: white; padding: 12px; position: sticky; top: 0; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .vocab-table td { background: #fff; padding: 15px 10px; vertical-align: middle; cursor: pointer; border-bottom: 1px solid #eee; }
  .vocab-table tr.marked-row td { background-color: var(--marked-bg) !important; border-color: var(--marked-border) !important; color: #c62828; }
  .hidden-text { opacity: 0.1; filter: blur(4px); transition: 0.3s; pointer-events: none; }
  .controls-bar { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 1rem; font-weight: bold; flex-shrink: 0; }
  .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }

  /* Modals */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
  .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
  .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 25px; padding: 30px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 5px solid var(--primary); position: relative; }
  .modal-vocab { font-size: 3.5rem; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
  .modal-read { font-size: 1.8rem; color: #555; margin-bottom: 10px; }
  .modal-mean { font-size: 2.5rem; color: var(--secondary); font-weight: bold; background: #f0fdfc; padding: 10px; border-radius: 15px; display: block; margin: 10px 0; cursor: pointer; border: 2px dashed var(--secondary); }
  .modal-mean:active { transform: scale(0.95); background: #b2dfdb; }
  .close-modal-btn { position: absolute; top: 10px; right: 10px; background: #eee; color: #333; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem; line-height: 35px; padding: 0; }
  .filter-group { text-align: left; margin-bottom: 15px; }
  .filter-label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }

  @keyframes popIn { from { transform: scale(0.5); opacity:0; } to { transform: scale(1); opacity:1; } }
  .correct-anim { background: var(--correct) !important; color: white !important; border-color: var(--correct) !important; transform: scale(1.05); }
  .wrong-anim { background: var(--wrong) !important; color: white !important; border-color: var(--wrong) !important; animation: shake 0.4s; }
  @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
  #mistakeList { text-align: left; padding: 0; list-style: none; }
  #mistakeList li { background: #fff; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; }

</style>
</head>
<body>

<div class="container">

  <div id="portalPage" class="page active">
    <div class="card" style="text-align: center; border: 5px solid #2196f3;">
      <h1 style="color: #e91e63; font-size: 2.8rem;">üéÆ Family Hub üéÆ</h1>
      
      <div style="background: #fff3e0; padding: 20px; border-radius: 20px; margin: 20px 0; border: 3px dashed #ffb74d;">
          <h2 style="margin: 0; color: #ff9800;">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° ‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå ‚≠ê</h2>
          <div id="grandTotalScore" style="font-size: 4rem; font-weight: 900; color: #f57c00;">0</div>
          <div style="display: flex; justify-content: space-around; font-size: 1rem; color: #666; margin-top: 10px;">
              <span>üê∞ ABC: <span id="portalAbcScore">0</span></span>
              <span>üßÆ Math: <span id="portalMathScore">0</span></span>
          </div>
      </div>

      <p style="color:#777; margin-bottom: 10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</p>
      
      <button class="btn-main" style="background: var(--primary); margin-bottom: 10px;" onclick="showPage('homePage')">
          üê∞ ABC Fun English
      </button>
      
      <button class="btn-main" style="background: #2196f3; box-shadow: 0 5px 0 #1565c0; margin-bottom: 20px;" onclick="openMathGame()">
          üßÆ ‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
      </button>

      <button class="btn-parent" style="width: 100%; font-size: 1.1rem; padding: 15px; margin-top: 10px;" onclick="showPage('hubParentLogin')">
          üîí ‡πÇ‡∏ã‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á
      </button>

      <div id="hubStatus" style="color: #888; font-size: 0.8rem; margin-top: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
    </div>
  </div>

  <div id="hubParentLogin" class="page">
    <div class="card">
      <h2>üîí ‡πÇ‡∏ã‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</h2>
      <input type="password" id="hubPinInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="padding:15px; font-size:1.2rem; text-align:center; width:80%; border:2px solid #ddd; border-radius:15px;">
      <br><br>
      <button class="btn-main" style="width: auto; padding: 10px 40px;" onclick="checkHubPin()">‡∏ï‡∏Å‡∏•‡∏á</button>
      <br>
      <button class="btn-back" onclick="showPage('portalPage')">‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

  <div id="hubParentDashboard" class="page">
    <div class="card">
       <h2 style="color:#673ab7;">üë®‚Äçüë©‚Äçüëß ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</h2>
       
       <div style="background: #f0f4f8; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px dashed #9c27b0;">
           <span style="font-size: 1.1rem;">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
           <div id="dashGrandTotal" style="font-size: 3rem; font-weight: bold; color: #9c27b0;">0</div>
       </div>

       <div class="score-mgmt-box">
          <h4 style="margin:0 0 10px 0; color:var(--primary);">üê∞ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏° ABC (Google Sheets)</h4>
          <div style="font-size: 1.1rem; margin-bottom: 10px;">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="dashAbcScore">0</b> ‡∏î‡∏≤‡∏ß</div>
          <div style="display:flex; gap:5px; align-items:center;">
              <input type="number" id="abcAdjInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß" style="padding:10px; width:100px; border-radius:10px; border:2px solid #ddd; text-align:center;">
              <button style="background:var(--correct); color:white; margin:0; width:auto; padding:10px 15px;" onclick="adjustAbcScore(1)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              <button style="background:var(--wrong); color:white; margin:0; width:auto; padding:10px 15px;" onclick="adjustAbcScore(-1)">- ‡∏•‡∏î</button>
          </div>
       </div>

       <div class="score-mgmt-box">
          <h4 style="margin:0 0 10px 0; color:#2196f3;">üßÆ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç (Firebase)</h4>
          <div style="font-size: 1.1rem; margin-bottom: 10px;">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="dashMathScore">0</b> ‡∏î‡∏≤‡∏ß</div>
          <div style="display:flex; gap:5px; align-items:center;">
              <input type="number" id="mathAdjInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß" style="padding:10px; width:100px; border-radius:10px; border:2px solid #ddd; text-align:center;">
              <button style="background:var(--correct); color:white; margin:0; width:auto; padding:10px 15px;" onclick="adjustMathScore(1)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              <button style="background:var(--wrong); color:white; margin:0; width:auto; padding:10px 15px;" onclick="adjustMathScore(-1)">- ‡∏•‡∏î</button>
          </div>
       </div>

       <div style="background:#f0f8ff; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #ddd;">
          <h4 style="margin:0 0 10px 0; color:#555;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ABC ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
          <ul id="historyList" class="history-list" style="max-height:180px;"><li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li></ul>
          <h4 style="margin:15px 0 10px 0; color:#555;">üìå ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢</h4>
          <ul id="mistakeList" style="max-height:180px; overflow-y:auto;"></ul>
       </div>

       <div style="border: 2px dashed #f44336; padding: 15px; border-radius: 15px; text-align:left;">
          <h4 style="color:#f44336; margin-top:0;">üõë ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Danger Zone)</h4>
          <button class="btn-reset" onclick="mathResetScores()">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Math</button>
          <button class="btn-reset" onclick="resetCloudData()" style="margin-top:5px;">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ABC</button>
       </div>
       
       <br>
       <button class="btn-back" style="width:100%; border: 2px solid #ddd;" onclick="showPage('portalPage')">üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>


  <div id="homePage" class="page">
    <div class="header-bar">
      <div class="stat-pill">‚≠ê ‡∏£‡∏ß‡∏°: <span id="uiStars">...</span></div>
      <div class="stat-pill">üèÜ ‡πÄ‡∏•‡πà‡∏ô: <span id="uiRounds">...</span> ‡∏£‡∏≠‡∏ö</div>
      <div id="onlineIndicator" style="font-size:0.7rem; color:#ccc;">‚ö™ Check...</div>
    </div>
    <div class="card">
      <h1>üê∞ ABC Fun</h1>
      <p style="color:#777; margin-bottom: 10px;">‡πÄ‡∏Å‡πà‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏â‡∏ö‡∏±‡∏ö‡∏´‡∏ô‡∏π‡∏ô‡πâ‡∏≠‡∏¢</p>
      
      <div style="background:#f9f9f9; padding:10px; border-radius:15px; margin-bottom:15px; display:flex; justify-content:center; align-items:center; gap:10px;">
        <span>üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:</span>
        <button id="soundToggle" onclick="toggleSound()" style="width:auto; padding:5px 20px; font-size:1rem; margin:0;">‡πÄ‡∏õ‡∏¥‡∏î</button>
      </div>

      <div id="loadingStatus" style="color: orange; font-style: italic; margin-bottom: 5px; font-size: 0.9rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      
      <div class="input-range-group">
        <span>‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà:</span>
        <input type="number" id="gameStartIdx" class="input-box" value="1">
        <span>‡∏ñ‡∏∂‡∏á</span>
        <input type="number" id="gameEndIdx" class="input-box" value="...">
      </div>

      <button class="btn-main" onclick="startGame()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)</button>
      <button class="btn-practice" onclick="startPractice()">üìñ ‡∏ù‡∏∂‡∏Å‡∏ó‡πà‡∏≠‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå</button>
      <br><br>
      <button class="btn-back" style="width:100%; border: 2px solid #ddd;" onclick="showPage('portalPage')">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <div id="gamePage" class="page">
    <div class="game-header">
      <div class="timer-box">‚è≥ <span id="timerDisplay">02:00</span></div>
      <div class="score-box">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="liveScore">0</span></div>
    </div>

    <div class="card">
      <div class="vocab-display" id="gameVocab">...</div>
      <button class="btn-sound" onclick="repeatSound()">üîä</button>
      <div id="choicesBox" class="choices-grid"></div>
    </div>
    <p style="color:#888; font-size: 0.8rem;">‡∏™‡∏π‡πâ‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á! ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ô‡πâ‡∏≤</p>
  </div>

  <div id="resultPage" class="page">
    <div class="card">
      <h1 style="color:var(--primary)">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ‚è∞</h1>
      <div style="font-size: 1.5rem; margin: 20px 0; background:#f0f8ff; padding:20px; border-radius:20px;">
        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ<br>
        <span id="finalScore" style="font-size: 4rem; color:var(--primary); font-weight:800;">0</span>
      </div>
      <div style="display:flex; justify-content:space-around; font-size:1.2rem;">
        <span style="color:green">‚úî ‡∏ñ‡∏π‡∏Å: <span id="resultCorrect">0</span></span>
        <span style="color:red">‚ùå ‡∏ú‡∏¥‡∏î: <span id="resultWrong">0</span></span>
      </div>
      <button class="btn-main" onclick="showPage('homePage')" style="margin-top:20px;">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π ABC</button>
      <button class="btn-back" onclick="showPage('portalPage')" style="width:100%; border: 2px solid #ddd;">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <div id="practicePage" class="page">
    <div class="card">
      <div class="practice-vocab" id="pVocab">...</div>
      <div id="pReading" style="color:#666; font-size: 1.8rem; margin-bottom: 10px;">...</div>
      <div id="pMeaning" style="color:var(--primary); font-size: 2.5rem; font-weight:bold; margin:10px 0; background: #fff8e1; padding: 10px; border-radius: 15px;">...</div>
      
      <button class="btn-sound" onclick="speakCurrentPractice()" style="margin: 20px auto;">üîä</button>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
        <button class="btn-back" style="font-size:1.2rem; padding:15px;" onclick="prevPractice()">‚¨ÖÔ∏è ‡∏ñ‡∏≠‡∏¢</button>
        <button class="btn-back" style="font-size:1.2rem; padding:15px;" onclick="nextPractice()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
      </div>
      <button class="btn-info" onclick="openVocabList()">üìú ‡∏î‡∏π‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
    <button class="btn-back" onclick="showPage('homePage')">üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π ABC</button>
  </div>

  <div id="vocabListPage" class="page">
    <div class="card">
      <h2 style="color:var(--primary); margin-top:0;">üìú ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      <button class="btn-filter" onclick="openFilterModal()">üîç Filter</button>
      <div class="controls-bar">
        <label class="checkbox-wrapper"><input type="checkbox" id="showRead" onchange="toggleVocabColumn('read')"> ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô</label>
        <label class="checkbox-wrapper"><input type="checkbox" id="showMean" onchange="toggleVocabColumn('mean')"> ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•</label>
      </div>
      <div class="table-wrapper">
        <table class="vocab-table">
            <thead>
                <tr><th style="width:15%">#</th><th style="width:30%">‡∏®‡∏±‡∏û‡∏ó‡πå</th><th style="width:25%">‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô</th><th style="width:30%">‡πÅ‡∏õ‡∏•</th></tr>
            </thead>
            <tbody id="vocabTableBody"></tbody>
        </table>
      </div>
      <div style="font-size:0.85rem; color:#888; margin: 5px 0;">üëÜ ‡∏à‡∏¥‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
      <button class="btn-back" onclick="showPage('practicePage')" style="flex-shrink:0;">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

  <div id="mathPage" class="page">
      <div class="math-box" id="mathAppContent">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå...
      </div>
  </div>

</div>

<div id="wordModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
        <button class="close-modal-btn" onclick="closeModal()">‚úï</button>
        <div id="modalVocab" class="modal-vocab">Word</div>
        <div id="modalRead" class="modal-read">reading...</div>
        <div id="modalMean" class="modal-mean" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">Meaning</div>
        <div style="font-size:0.8rem; color:#888;">(‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</div>
        <button class="btn-sound" onclick="speakFromModal()" style="margin: 15px auto;">üîä</button>
        <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:15px;">
            <p id="markStatusText" style="color:red; font-size:0.9rem;">üö© ‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏ï‡∏≥‡∏´‡∏ô‡∏¥‡πÑ‡∏ß‡πâ (‡∏¢‡∏±‡∏á‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</p>
            <button onclick="resetWordStatus()" style="background:#fff; border:1px solid #ccc; color:#555; font-size:0.9rem; padding:8px;">üîí ‡∏•‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)</button>
        </div>
    </div>
</div>

<div id="filterModal" class="modal-overlay" onclick="closeFilterModal(event)">
    <div class="modal-box" onclick="event.stopPropagation()" style="text-align:left;">
        <button class="close-modal-btn" onclick="closeFilterModal()">‚úï</button>
        <h2 style="color:var(--secondary); text-align:center; margin-top:0;">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h2>
        <div class="filter-group">
            <label class="filter-label">üî§ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥:</label>
            <input type="text" id="filterSearch" class="search-box" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏®‡∏±‡∏û‡∏ó‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•...">
        </div>
        <div class="filter-group">
            <label class="filter-label">üî¢ ‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥:</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="filterStart" class="input-box" style="width:100%" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°">
                <span>‡∏ñ‡∏∂‡∏á</span>
                <input type="number" id="filterEnd" class="input-box" style="width:100%" placeholder="‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î">
            </div>
        </div>
        <div class="filter-group">
            <label class="filter-label" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="filterMarkedOnly" style="transform:scale(1.5);">
                <span style="color:red; font-weight:bold;">üö© ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏™‡∏µ‡πÅ‡∏î‡∏á)</span>
            </label>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-back" onclick="resetFilters()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            <button class="btn-apply" onclick="applyFilters()">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>
</div>

<script>
/**********************************************
 * FAMILY HUB GLOBAL SYSTEM
 **********************************************/
let mathScoreGlobal = 0; // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Math (Firebase)
let abcScoreGlobal = 0;  // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å ABC (Google Sheets)

const mathPlayer = "‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå"; // ‡∏•‡πá‡∏≠‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
const mathAvatar = "üë¶"; // ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£

function showPage(id) {
    if(id !== 'mathPage') {
        const mathSb = document.getElementById("mathScoreBox");
        if(mathSb) mathSb.remove();
    }
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    updateGrandTotal();
}

function updateGrandTotal() {
    let total = abcScoreGlobal + mathScoreGlobal;
    document.getElementById('portalAbcScore').textContent = abcScoreGlobal;
    document.getElementById('portalMathScore').textContent = mathScoreGlobal;
    document.getElementById('grandTotalScore').textContent = total.toLocaleString();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Parent ‡∏î‡πâ‡∏ß‡∏¢
    if(document.getElementById('dashGrandTotal')) document.getElementById('dashGrandTotal').textContent = total.toLocaleString();
    if(document.getElementById('dashAbcScore')) document.getElementById('dashAbcScore').textContent = abcScoreGlobal;
    if(document.getElementById('dashMathScore')) document.getElementById('dashMathScore').textContent = mathScoreGlobal;
}

/**********************************************
 * MATH GAME LOGIC (Firebase - Separated logic)
 **********************************************/
const firebaseConfig = {
    apiKey: "AIzaSyD5Nhoo-gr8PopUEJK7YWRny-AY2ezKgAY",
    authDomain: "mathgamefamily.firebaseapp.com",
    databaseURL: "https://mathgamefamily-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mathgamefamily"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let mathLevel=1, mathAnswer=0, mathCurrentScore=0, mathQCount=0, mathTimeLeft=120, mathTimerId=null;
const mathTotalQ = 7;

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå)
db.ref('scores/' + mathPlayer).on('value', snap => {
    mathScoreGlobal = snap.exists() ? (snap.val().score || 0) : 0;
    updateGrandTotal();
});

function openMathGame() {
    showPage('mathPage');
    mathHomeInit();
}

function mathHomeInit(){
    document.getElementById("mathScoreBox")?.remove();
    document.getElementById("mathAppContent").innerHTML = `
        <h2 style="color:#1565c0">üßÆ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
        <div style="font-size:30px; margin-bottom:15px; background:#e3f2fd; padding:10px; border-radius:15px; border:2px solid #2196f3;">
            ${mathAvatar} <b>${mathPlayer}</b>
        </div>
        üéì <b>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</b> <br><br>
        <button id="lv1" class="btn-lv ${mathLevel==1?'sel':''}" onclick="mathPickLevel(1)">‡∏õ.1</button>
        <button id="lv2" class="btn-lv ${mathLevel==2?'sel':''}" onclick="mathPickLevel(2)">‡∏õ.2</button>
        <button id="lv3" class="btn-lv ${mathLevel==3?'sel':''}" onclick="mathPickLevel(3)">‡∏õ.3</button><br><br>
        <div style="font-size:0.9rem; color:#888; margin-bottom:15px;">* ‡∏õ.1 (+2/-1), ‡∏õ.2 (+5/-2), ‡∏õ.3 (+10/-3)</div>
        <button style="width:90%; background:#4caf50;" onclick="mathStart()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button><br>
        <button class="back" style="width:100%; margin-top:15px; border: 2px solid #e65100;" onclick="showPage('portalPage')">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    `;
}

function mathPickLevel(l){ mathLevel=l; document.querySelectorAll("#mathPage .btn-lv").forEach(b=>b.classList.remove("sel")); document.getElementById("lv"+l).classList.add("sel"); }

function mathStart(){ 
    mathCurrentScore=0; mathQCount=0; 
    mathNextQ(); 
}

function mathNextQ(){
    if(mathQCount >= mathTotalQ){ mathSummary(); return; }
    mathQCount++; clearInterval(mathTimerId); mathUpdateScoreUI();
    
    let a, b, op="+";
    if(mathLevel==1){ a=mathR(1,20); b=mathR(1,10); op="+"; }
    else if(mathLevel==2){ a=mathR(10,90); b=mathR(10,50); op=Math.random()>0.5?"+":"-"; }
    else if(mathLevel==3){ a=mathR(2,12); b=mathR(2,12); op="√ó"; }

    if(op=="+") mathAnswer=a+b; 
    if(op=="-"){ if(b>a)[a,b]=[b,a]; mathAnswer=a-b; } 
    if(op=="√ó") mathAnswer=a*b;
    
    mathTimeLeft = 120;
    document.getElementById("mathAppContent").innerHTML = `
        <div class="timer">‚è≥ <span id="t-val">${mathTimeLeft}</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div style="font-size:18px; color:#666">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${mathQCount} / ${mathTotalQ}</div>
        <h1 style="font-size:55px; margin:10px 0;">${a} ${op} ${b}</h1>
        <input id="ans" type="number" readonly placeholder="?"><br><br>
        <div>
            ${[1,2,3,4,5,6,7,8,9,0].map(n=>`<button class="num" onclick="mathPress(${n})">${n}</button>`).join("")}
            <button class="num" style="background:#f44336; color:#fff" onclick="document.getElementById('ans').value=''">C</button>
        </div><br>
        <button style="width:90%; background:#4caf50; height:60px; font-size:24px;" onclick="mathCheck()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    `;
    mathTimerId = setInterval(() => { 
        mathTimeLeft--; document.getElementById('t-val').innerText=mathTimeLeft; 
        if(mathTimeLeft<=0) mathCheck(); // ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏¢ (‡∏ú‡∏¥‡∏î)
    }, 1000);
}

function mathPress(n){ document.getElementById('ans').value += n; }
function mathR(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function mathUpdateScoreUI(){
    let sb = document.getElementById("mathScoreBox") || (document.body.insertAdjacentHTML("beforeend", `<div id="mathScoreBox" class="mathScoreBox"></div>`), document.getElementById("mathScoreBox"));
    sb.innerText = "‚≠ê " + mathCurrentScore;
}

function mathCheck(){
    clearInterval(mathTimerId);
    let userAns = parseInt(document.getElementById("ans").value);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á)
    let ptsEarned = mathLevel == 1 ? 2 : (mathLevel == 2 ? 5 : 10);
    let ptsPenalty = mathLevel == 1 ? 1 : (mathLevel == 2 ? 2 : 3);

    if(userAns === mathAnswer){
        mathCurrentScore += ptsEarned;
        mathNextQ(); // ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å
    } else {
        mathCurrentScore -= ptsPenalty; // ‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        document.getElementById("mathAppContent").innerHTML = `
            <h2 style="color:red">‚ùå ‡∏ú‡∏¥‡∏î‡∏à‡πâ‡∏≤!</h2>
            <h1 style="font-size:30px">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ <span style="color:green; font-size:50px">${mathAnswer}</span></h1>
            <p style="color:#f44336; font-size:22px; font-weight:bold;">‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å ${ptsPenalty} ‡∏î‡∏≤‡∏ß üò¢</p>
            <button style="width:90%; background:#2196f3;" onclick="mathNextQ()">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚ñ∂</button>
        `;
    }
}

function mathSummary(){
    document.getElementById("mathScoreBox")?.remove();
    
    db.ref('scores/'+mathPlayer).once('value', snap => {
        let oldScore = snap.exists() ? snap.val().score : 0;
        let newTotal = oldScore + mathCurrentScore;
        
        db.ref('scores/'+mathPlayer).set({
            name: mathPlayer, score: newTotal, avatar: mathAvatar,
            lastPlayed: new Date().toLocaleString('th-TH')
        });

        document.getElementById("mathAppContent").innerHTML = `
            <div style="padding:20px;">
                <h2 style="color:#4caf50">üéä ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß!</h2>
                <h1 style="font-size:60px">${mathAvatar}</h1>
                <h3>‡∏Ñ‡∏∏‡∏ì ${mathPlayer}</h3>
                <p>‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÑ‡∏î‡πâ (‡∏´‡∏±‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß): <b>${mathCurrentScore > 0 ? '+' : ''}${mathCurrentScore}</b> ‡πÅ‡∏ï‡πâ‡∏°</p>
                <h2 style="color:#0d47a1">‡πÅ‡∏ï‡πâ‡∏° Math: ${newTotal.toLocaleString()} ‚≠ê</h2>
                <button style="width:90%; background:#607d8b;" onclick="mathHomeInit()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π Math</button>
            </div>
        `;
    });
}

function mathResetScores(){
    if(confirm("üõë ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
        db.ref('scores/'+mathPlayer).remove(); 
        alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); 
    }
}


/**********************************************
 * UNIFIED PARENT ZONE
 **********************************************/
const PARENT_PIN = "0932815229";

function checkHubPin() {
    if(document.getElementById("hubPinInput").value === PARENT_PIN) {
        document.getElementById("hubPinInput").value = "";
        showPage('hubParentDashboard');
        renderHistory();  // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ABC
        renderMistakes(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î‡∏Ç‡∏≠‡∏á ABC
    } else { 
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); 
    }
}

function adjustAbcScore(multiplier) {
    const inputVal = parseInt(document.getElementById("abcAdjInput").value);
    if (isNaN(inputVal) || inputVal <= 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"); return; }
    
    const amount = inputVal * multiplier; 
    const actionText = multiplier > 0 ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‡∏•‡∏î';
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£${actionText}‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ù‡∏±‡πà‡∏á ABC ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${inputVal} ‡∏î‡∏≤‡∏ß?`)) return;
    
    abcScoreGlobal += amount; 
    if(abcScoreGlobal < 0) abcScoreGlobal = 0; 
    
    updateAbcUI(); 
    updateGrandTotal();
    sendDataToSheets(amount, `[‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á${actionText}‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô]`);
    
    document.getElementById("abcAdjInput").value = ""; 
    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£${actionText}‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ABC ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö Cloud)`);
}

function adjustMathScore(multiplier) {
    const inputVal = parseInt(document.getElementById("mathAdjInput").value);
    if (isNaN(inputVal) || inputVal <= 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"); return; }
    
    const amount = inputVal * multiplier; 
    const actionText = multiplier > 0 ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‡∏•‡∏î';
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£${actionText}‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${inputVal} ‡∏î‡∏≤‡∏ß?`)) return;
    
    db.ref('scores/'+mathPlayer+'/score').once('value', sn => {
        let curMath = sn.val() || 0;
        let newScore = curMath + amount;
        db.ref('scores/'+mathPlayer+'/score').set(newScore);
        document.getElementById("mathAdjInput").value = ""; 
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£${actionText}‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    });
}


/**********************************************
 * ABC FUN ENGLISH LOGIC (Google Sheets)
 **********************************************/
const API_URL = "https://script.google.com/macros/s/AKfycbzfNeVpEL2R3sQsljaYsOjRqoFkjf2j6oM1KKXKvOi2Y0peu07j20A0ff4GZafUFg23/exec"; 
const GAME_TIME = 120; // 2 ‡∏ô‡∏≤‡∏ó‡∏µ

const backupWords = [
  {Vocabulary:"Apple", "‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢":"‡πÅ‡∏≠‡∏õ-‡πÄ‡∏õ‡∏¥‡∏•", "‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•":"‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•"},
  {Vocabulary:"Banana", "‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢":"‡∏ö‡∏∞-‡πÅ‡∏ô-‡∏ô‡∏∞", "‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•":"‡∏Å‡∏•‡πâ‡∏ß‡∏¢"}
];

let words = []; let gamePool = []; 
let wordStats = JSON.parse(localStorage.getItem("wordStats")) || {};
let markedWords = JSON.parse(localStorage.getItem("markedWords")) || {};
let userSettings = JSON.parse(localStorage.getItem("userSettings")) || { showRead: true, showMean: true };
let currentFilters = { search: "", start: null, end: null, markedOnly: false };

let globalRounds = 0; let isSoundEnabled = true;
let currentWord = null; let currentModalWord = null; 
let abcTimerId = null; let abcTimeLeft = 0; let abcCurrentScore = 0;
let sessionCorrect = 0; let sessionWrong = 0; let practiceIndex = 0; let sessionWrongStats = {}; 

function fetchAbcData() {
    const nocache = "&t=" + new Date().getTime();
    fetch(API_URL + "?action=getReport" + nocache).then(res => res.json()).then(data => {
        if(data.summary) {
            abcScoreGlobal = data.summary.stars;
            globalRounds = data.summary.rounds;
            updateAbcUI(); updateGrandTotal();
        }
    }).catch(console.error);

    fetch(API_URL).then(res => res.json()).then(data => {
        if(data.words) words = data.words; else if(Array.isArray(data)) words = data;
        if(words.length > 0) {
            document.getElementById("loadingStatus").textContent = `‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô (${words.length} ‡∏Ñ‡∏≥)`;
            document.getElementById("onlineIndicator").textContent = "üü¢ Online (Synced)";
            document.getElementById("onlineIndicator").style.color = "green";
            document.getElementById("gameEndIdx").value = words.length;
            document.getElementById("hubStatus").textContent = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Cloud ‡∏Ñ‡∏£‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß";
            document.getElementById("hubStatus").style.color = "green";
        }
    }).catch(e => {
        words = backupWords;
        document.getElementById("loadingStatus").textContent = "‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)";
        document.getElementById("onlineIndicator").textContent = "üî¥ Offline";
        document.getElementById("gameEndIdx").value = words.length;
    });
}

function toggleSound() { isSoundEnabled = !isSoundEnabled; toggleSoundUI(); if(isSoundEnabled) window.speechSynthesis.speak(new SpeechSynthesisUtterance("")); }
function toggleSoundUI() {
  const btn = document.getElementById("soundToggle");
  if(isSoundEnabled) { btn.textContent = "‡πÄ‡∏õ‡∏¥‡∏î (0.5 ‡πÅ‡∏ï‡πâ‡∏°)"; btn.style.background = "var(--correct)"; btn.style.color = "white"; } 
  else { btn.textContent = "‡∏õ‡∏¥‡∏î (1 ‡πÅ‡∏ï‡πâ‡∏°)"; btn.style.background = "#ccc"; btn.style.color = "#666"; }
}

function speak(text, lang = "en-US") {
  if(!isSoundEnabled) return; window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text); u.lang = lang; u.rate = 0.8;
  const voices = window.speechSynthesis.getVoices();
  if(lang === "en-US") { const f = voices.find(v => v.name.includes("Female") || v.name.includes("Google US English")); if(f) u.voice = f; } 
  else if (lang === "th-TH") { const t = voices.find(v => v.lang === "th-TH" || v.name.includes("Thai")); if(t) u.voice = t; }
  window.speechSynthesis.speak(u);
}

function updateAbcUI() {
  document.getElementById("uiStars").textContent = abcScoreGlobal;
  document.getElementById("uiRounds").textContent = globalRounds;
}

function startGame() {
  if(words.length < 4) { alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
  let start = parseInt(document.getElementById("gameStartIdx").value);
  let end = parseInt(document.getElementById("gameEndIdx").value);
  if(isNaN(start) || start < 1) start = 1; if(isNaN(end) || end > words.length) end = words.length;
  if(start > end) { alert("‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
  gamePool = words.slice(start - 1, end);
  if(gamePool.length < 4) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏Ñ‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
  
  abcCurrentScore = 0; sessionCorrect = 0; sessionWrong = 0; abcTimeLeft = GAME_TIME; sessionWrongStats = {};
  document.getElementById("liveScore").textContent = "0"; showPage('gamePage'); updateTimerDisplay();
  
  clearInterval(abcTimerId);
  abcTimerId = setInterval(() => { abcTimeLeft--; updateTimerDisplay(); if(abcTimeLeft <= 0) finishGame(); }, 1000);
  nextQuestion();
}

function updateTimerDisplay() {
  const m = Math.floor(abcTimeLeft / 60); const s = abcTimeLeft % 60;
  document.getElementById("timerDisplay").textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function getWeightedWord() {
  let pool = [];
  gamePool.forEach(w => { pool.push(w); const stat = wordStats[w.Vocabulary]; if (stat && stat.wrong > stat.correct) { pool.push(w); pool.push(w); }});
  return pool[Math.floor(Math.random() * pool.length)];
}

function nextQuestion() {
  if(abcTimeLeft <= 0) return; currentWord = getWeightedWord();
  document.getElementById("gameVocab").textContent = currentWord.Vocabulary; speak(currentWord.Vocabulary);
  let choices = [currentWord];
  while(choices.length < 4) { let w = gamePool[Math.floor(Math.random() * gamePool.length)]; if(!choices.find(c => c.Vocabulary === w.Vocabulary)) choices.push(w); }
  const box = document.getElementById("choicesBox"); box.innerHTML = "";
  choices.sort(() => Math.random() - 0.5).forEach(w => {
    const btn = document.createElement("button"); btn.className = "choice-btn"; btn.textContent = w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"];
    btn.onclick = () => checkAnswer(w, btn); box.appendChild(btn);
  });
}

function checkAnswer(selected, btn) {
  const allBtns = document.querySelectorAll('.choice-btn'); allBtns.forEach(b => b.disabled = true);
  if(!wordStats[currentWord.Vocabulary]) wordStats[currentWord.Vocabulary] = { correct:0, wrong:0, meaning: currentWord["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"] };
  if(selected.Vocabulary === currentWord.Vocabulary) {
    abcCurrentScore += isSoundEnabled ? 0.5 : 1; sessionCorrect++; wordStats[currentWord.Vocabulary].correct++;
    btn.classList.add("correct-anim");
    if(isSoundEnabled) new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg").play().catch(e=>{});
    setTimeout(nextQuestion, 800);
  } else {
    btn.classList.add("wrong-anim"); abcCurrentScore -= 1; sessionWrong++; wordStats[currentWord.Vocabulary].wrong++;
    if(!sessionWrongStats[currentWord.Vocabulary]) sessionWrongStats[currentWord.Vocabulary] = 0; sessionWrongStats[currentWord.Vocabulary]++;
    allBtns.forEach(b => { if(b.textContent === currentWord["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"]) b.classList.add("correct-anim"); });
    if(isSoundEnabled) new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play().catch(e=>{});
    setTimeout(nextQuestion, 1500);
  }
  document.getElementById("liveScore").textContent = abcCurrentScore; localStorage.setItem("wordStats", JSON.stringify(wordStats));
}

function sendDataToSheets(stars, wrongWords) {
  fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'save', totalStars: stars, wrongWords: wrongWords }) })
  .then(res => { console.log("Saved."); setTimeout(fetchAbcData, 1000); }).catch(err => console.error(err));
}

function finishGame() {
  clearInterval(abcTimerId); globalRounds++; abcScoreGlobal += Math.max(0, abcCurrentScore); updateAbcUI(); updateGrandTotal();
  const wrongWordsSummary = Object.entries(sessionWrongStats).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([v, c]) => `${v}(${c})`).join(", ");
  sendDataToSheets(abcCurrentScore, wrongWordsSummary);
  document.getElementById("finalScore").textContent = abcCurrentScore; document.getElementById("resultCorrect").textContent = sessionCorrect;
  document.getElementById("resultWrong").textContent = sessionWrong; showPage('resultPage');
}

function repeatSound() { if(currentWord) speak(currentWord.Vocabulary); }

function startPractice() { if(words.length === 0) return; practiceIndex = 0; showPage('practicePage'); renderPractice(); }
function renderPractice() {
  const w = words[practiceIndex];
  document.getElementById("pVocab").textContent = w.Vocabulary || ""; document.getElementById("pReading").textContent = w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"] ? "‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô: " + w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"] : "";
  document.getElementById("pMeaning").textContent = w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"] ? "‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤: " + w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"] : ""; speak(w.Vocabulary);
}
function nextPractice() { practiceIndex = (practiceIndex + 1) % words.length; renderPractice(); }
function prevPractice() { practiceIndex = practiceIndex <= 0 ? words.length - 1 : practiceIndex - 1; renderPractice(); }
function speakCurrentPractice() { speak(words[practiceIndex].Vocabulary); }

function openVocabList() { showPage('vocabListPage'); renderVocabTable(); document.getElementById('showRead').checked = userSettings.showRead; document.getElementById('showMean').checked = userSettings.showMean; toggleVocabColumn('read', false); toggleVocabColumn('mean', false); }
function renderVocabTable() {
    const tbody = document.getElementById("vocabTableBody"); tbody.innerHTML = "";
    words.forEach((w, index) => {
        const realIndex = index + 1; const isMarked = markedWords[w.Vocabulary];
        if(currentFilters.start && realIndex < currentFilters.start) return; if(currentFilters.end && realIndex > currentFilters.end) return;
        if(currentFilters.markedOnly && !isMarked) return;
        if(currentFilters.search) { const t = currentFilters.search.toLowerCase(); const match = w.Vocabulary.toLowerCase().includes(t) || w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"].includes(t) || (w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"] && w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"].includes(t)); if(!match) return; }
        const tr = document.createElement("tr"); if(isMarked) tr.classList.add("marked-row"); tr.onclick = () => openWordModal(w, tr);
        const tdIdx = document.createElement("td"); tdIdx.textContent = realIndex; tdIdx.style.fontWeight = "bold"; tdIdx.style.color = "#888";
        const tdVocab = document.createElement("td"); tdVocab.innerHTML = `<b style="font-size:1.2rem; color:var(--primary)">${w.Vocabulary}</b>`;
        const tdRead = document.createElement("td"); tdRead.className = "col-read hidden-text"; tdRead.textContent = w["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"];
        const tdMean = document.createElement("td"); tdMean.className = "col-mean hidden-text"; tdMean.textContent = w["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"];
        tr.append(tdIdx, tdVocab, tdRead, tdMean); tbody.appendChild(tr);
    });
}

function openFilterModal() { document.getElementById('filterModal').classList.add('active'); document.getElementById('filterSearch').value = currentFilters.search; document.getElementById('filterStart').value = currentFilters.start || ''; document.getElementById('filterEnd').value = currentFilters.end || ''; document.getElementById('filterMarkedOnly').checked = currentFilters.markedOnly; }
function closeFilterModal(event) { if(event && event.target.id !== "filterModal" && !event.target.classList.contains('close-modal-btn')) return; document.getElementById('filterModal').classList.remove('active'); }
function applyFilters() {
    currentFilters.search = document.getElementById('filterSearch').value.trim(); const s = parseInt(document.getElementById('filterStart').value); const e = parseInt(document.getElementById('filterEnd').value); currentFilters.start = isNaN(s) ? null : s; currentFilters.end = isNaN(e) ? null : e; currentFilters.markedOnly = document.getElementById('filterMarkedOnly').checked;
    renderVocabTable(); closeFilterModal();
}
function resetFilters() { currentFilters = { search: "", start: null, end: null, markedOnly: false }; document.getElementById('filterSearch').value = ""; document.getElementById('filterStart').value = ""; document.getElementById('filterEnd').value = ""; document.getElementById('filterMarkedOnly').checked = false; renderVocabTable(); closeFilterModal(); }
function toggleVocabColumn(type, isUserAction = true) {
    const cbId = type === 'read' ? 'showRead' : 'showMean'; const isChecked = document.getElementById(cbId).checked;
    if(isUserAction) { userSettings[cbId] = isChecked; localStorage.setItem("userSettings", JSON.stringify(userSettings)); }
    const cells = document.querySelectorAll(type === 'read' ? '.col-read' : '.col-mean'); cells.forEach(c => { if(isChecked) c.classList.remove('hidden-text'); else c.classList.add('hidden-text'); });
}

function openWordModal(wordObj, trElement) {
    currentModalWord = wordObj; document.getElementById('modalVocab').textContent = wordObj.Vocabulary; document.getElementById('modalRead').textContent = wordObj["‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢"];
    const meanElem = document.getElementById('modalMean'); meanElem.textContent = wordObj["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"]; meanElem.onclick = function() { speak(wordObj["‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•"], 'th-TH'); };
    const statusText = document.getElementById('markStatusText');
    if(markedWords[wordObj.Vocabulary]) { statusText.style.display = "block"; } else { markedWords[wordObj.Vocabulary] = true; localStorage.setItem("markedWords", JSON.stringify(markedWords)); if(trElement) trElement.classList.add("marked-row"); statusText.style.display = "block"; statusText.textContent = "üö© ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢"; }
    document.getElementById('wordModal').classList.add('active'); speak(wordObj.Vocabulary);
}
function closeModal(event) { if(event && event.target.id !== "wordModal" && !event.target.classList.contains('close-modal-btn')) return; document.getElementById('wordModal').classList.remove('active'); renderVocabTable(); }
function speakFromModal() { if(currentModalWord) speak(currentModalWord.Vocabulary); }
function resetWordStatus() {
    if(!currentModalWord) return; const pin = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:");
    if(pin === PARENT_PIN) { delete markedWords[currentModalWord.Vocabulary]; localStorage.setItem("markedWords", JSON.stringify(markedWords)); alert("‚úÖ ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); document.getElementById('markStatusText').style.display = "none"; closeModal(); } else if (pin !== null) { alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
}

async function renderHistory() {
  const list = document.getElementById("historyList"); list.innerHTML = "<li>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud...</li>";
  try {
    const nocache = "&t=" + new Date().getTime(); const res = await fetch(API_URL + "?action=getReport" + nocache); const data = await res.json();
    if(data.summary) { abcScoreGlobal = data.summary.stars; globalRounds = data.summary.rounds; updateAbcUI(); updateGrandTotal(); }
    list.innerHTML = ""; if (!data.history || data.history.length === 0) { list.innerHTML = "<li style='justify-content:center; color:#888;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô Cloud</li>"; return; }
    data.history.forEach(item => {
      const dateObj = new Date(item.timestamp); const dateStr = dateObj.toLocaleDateString("th-TH") + " " + dateObj.toLocaleTimeString("th-TH", {hour:'2-digit', minute:'2-digit'});
      const li = document.createElement("li");
      li.innerHTML = `<div class="history-header"><span class="date-label">${dateStr}</span><div class="badge-group"><span class="count-label" style="background:var(--primary)">‚≠ê ${item.stars}</span></div></div>${item.wrong ? `<div class="wrong-text">‚ùå ${item.wrong}</div>` : ''}`;
      list.appendChild(li);
    });
  } catch (e) { console.error(e); list.innerHTML = "<li style='color:red;'>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</li>"; }
}

function renderMistakes() {
  const list = document.getElementById("mistakeList"); list.innerHTML = "";
  const sorted = Object.entries(wordStats).sort((a,b) => b[1].wrong - a[1].wrong).slice(0, 15);
  if(sorted.length === 0) { list.innerHTML = "<li style='justify-content:center; color:#888;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</li>"; return; }
  sorted.forEach(([vocab, s]) => { if(s.wrong > 0) { const li = document.createElement("li"); li.innerHTML = `<span><b>${vocab}</b> (${s.meaning})</span> <span style="color:red">‡∏ú‡∏¥‡∏î ${s.wrong}</span>`; list.appendChild(li); }});
}

function resetCloudData() {
  if(!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô ABC ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô Google Sheets\n\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "reset" }) }).then(res => {
      alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); localStorage.clear(); markedWords = {}; userSettings = { showRead: true, showMean: true }; currentFilters = { search: "", start: null, end: null, markedOnly: false }; abcScoreGlobal = 0; globalRounds = 0; location.reload();
  }).catch(err => { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud"); });
}

// Initial Bootup Hook
window.onload = function() {
    toggleSoundUI();
    fetchAbcData(); // Pull Google Sheet data
    window.speechSynthesis.getVoices();
};

</script>
</body>
</html>
